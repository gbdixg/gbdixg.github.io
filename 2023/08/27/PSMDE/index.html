<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>PSMDE - PowerShell Defender for Endpoint Module | Write-Verbose</title><meta name=keywords content="PowerShell,Defender"><meta name=description content="A PowerShell Module for access to the Defender Security API."><meta name=author content="GD"><link rel=canonical href=https://write-verbose.com/2023/08/27/PSMDE/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.js onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://write-verbose.com/fav/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://write-verbose.com/fav/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://write-verbose.com/fav/favicon-32x32.png><link rel=apple-touch-icon href=https://write-verbose.com/apple-touch-icon.png><link rel=mask-icon href=https://write-verbose.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/hybrid.min.css integrity="sha512-BoPJq6KvI1u+cpSqlC0hoQBjJNPcq1xpOncS9hMdGLMBoLJO7qGIZbK5YOk0DkIvn4EmKyZRpcwjLm4GygUX+g==" crossorigin=anonymous><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-141237050-1","auto"),ga("send","pageview"))</script><meta property="og:title" content="PSMDE - PowerShell Defender for Endpoint Module"><meta property="og:description" content="A PowerShell Module for access to the Defender Security API."><meta property="og:type" content="article"><meta property="og:url" content="https://write-verbose.com/2023/08/27/PSMDE/"><meta property="og:image" content="https://write-verbose.com/papermod-cover.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-08-27T00:00:00+00:00"><meta property="article:modified_time" content="2023-08-27T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://write-verbose.com/papermod-cover.png"><meta name=twitter:title content="PSMDE - PowerShell Defender for Endpoint Module"><meta name=twitter:description content="A PowerShell Module for access to the Defender Security API."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://write-verbose.com/posts/"},{"@type":"ListItem","position":2,"name":"PSMDE - PowerShell Defender for Endpoint Module","item":"https://write-verbose.com/2023/08/27/PSMDE/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"PSMDE - PowerShell Defender for Endpoint Module","name":"PSMDE - PowerShell Defender for Endpoint Module","description":"A PowerShell Module for access to the Defender Security API.","keywords":["PowerShell","Defender"],"articleBody":"PSMDE is a PowerShell module providing interactive access to Device information, Advanced Hunting data and machine actions.\nModule Functions Connect-PSMDE Get-PSMDEDeviceInfo Get-PSMDELatestVersion Invoke-PSMDEAvScan Invoke-PSMDEAdvancedHunting Invoke-PSMDEIsolation Revoke-PSMDEIsolation Invoke-PSMDEFileQuarantine Save-PSMDESupportInfo Test-PSMDEMapsConnection Installation Create Azure App Create an Azure application to control authentication and authorization.\nA step by step process is available here The API permissions required are available in the Help text of each module function.\nInstall MSAL.PS PSMDE relies on another module for authentication. Install the MSAL.PS module from the PowerShell gallery.\nInstall-Module MSAL.PS -Scope CurrentUser Download PSMDE The PSMDE module is available from GitHub\nClick on Code \u003e Download Zip\nUnblock the zip file and extract it to a folder in the $ENV:PSModule path\nMake sure you rename the root folder from PSMDE-master to PSMDE\nEdit the Public\\Connect-PSMDE.ps1 file to set your TenantID and ApplicationID\n# Connect-PSMDE before edit Param( [parameter()] [ValidateNotNullOrEmpty()] [String]$TenantID = '00000000-0000-0000-0000-TENANTID' , [parameter()] [ValidateNotNullOrEmpty()] [String]$ClientID = '00000000-0000-0000-0000-APPID' Usage Security Context Start PowerShell in the context of an account with access to Defender information i.e. a member of\nA built in reader role such as Global Reader or Security Reader A privileged role such as Global Admin, Security Opertator, Security Admin A custom role with delegated access to your tenant Interactive PowerShell Use the module interactively at PowerShell console and explore the module functions\nImport-Module PSMDE # Load the module Get-Command -Module PSMDE # List available commands Get-Help Get-PSMDEDeviceInfo # Get help on a command EXAMPLE 1 - Get device information The example below confirms the following for an endpoint:\nDefender is active and onboarded Engine and signatures are up-to-date Last scan times OS version and IP address information Logged-on users MDE alerts Vulnerabilities Import-Module PSMDE Connect-PSMDE -TenantID $TenantID -ClientID $AppID # Optional parameters. Set defaults in the Connect-PSMDE.ps1 file Get-PSMDEDeviceInfo -Computername PC12345 Computername : PC12345 osPlatform : Windows10 version : 22H2 osBuild : 19045 isPotentialDuplication : False machineTags : {MDEPilot} healthStatus : Active onboardingStatus : Onboarded defenderAvStatus : Updated exposureLevel : Medium riskScore : Medium avEngineVersion : 1.1.23080.2005 avSignatureVersion : 1.395.1403.0 avPlatformVersion : 4.18.23080.2006 avIsSignatureUpToDate : True avIsEngineUpToDate : True avIsPlatformUpToDate : True avSignatureDataRefreshTime : 27/08/2023 15:35:36 avSignatureDataRefreshTimeUTC : 27/08/2023 14:35:36 quickScanTime : 22/08/2023 03:16:00 quickScanTimeUTC : 22/08/2023 02:16:00 fullScanTime : fullScanTimeUTC : avmode : 0 LastSeen : 27/08/2023 14:53:08 LastSeenUTC : 27/08/2023 13:53:08 lastIpAddress : 192.168.1.140 lastExternalIpAddress : 100.19.112.28 managedBy : Intune loggedOnUsers : {@{id=RnD\\user1; lastSeen=27/08/2023 16:23:38; logonTypes=RemoteInteractive}, @{id=azuread\\admin1; lastSeen=27/08/2023 16:02:54; logonTypes=Interactive}} alertCount : 9 alerts : {@{serverity=Informational; alertCreationTime=2023-05-08T19:45:47.8359999Z; detectionSource=AutomatedInvestigation; category=SuspiciousActivity; threatName=; threatFamilyName=}, @{serverity=Informational; alertCreationTime=2023-08-15T21:55:56.9250938Z; detectionSource=WindowsDefenderAv; category=Malware; threatName=Virus:DOS/EICAR_Test_File; threatFamilyName=EICAR_Test_File}, @{serverity=Medium; alertCreationTime=2023-05-08T16:11:02.4388031Z; detectionSource=WindowsDefenderAv; category=SuspiciousActivity; threatName=Trojan:PowerShell/Powersploit.L; threatFamilyName=Powersploit}, @{serverity=Medium; alertCreationTime=2023-05-08T16:02:13.0120825Z; detectionSource=WindowsDefenderAtp; category=Execution; threatName=; threatFamilyName=}...} CVEs : {@{name=CVE-2023-33144; description=Visual Studio Code Spoofing Vulnerability; severity=Medium; publicExploit=False; firstDetected=2023-06-13T17:30:51Z}, @{name=CVE-2023-21779; description=Visual Studio Code Remote Code Execution Vulnerability; severity=High; publicExploit=False; firstDetected=2023-05-02T14:45:15Z}, @{name=CVE-2023-24893; description=Visual Studio Code Remote Code Execution Vulnerability; severity=High; publicExploit=False; firstDetected=2023-05-02T14:45:15Z}, @{name=CVE-2023-29338; description=Visual Studio Code Information Disclosure Vulnerability; severity=Medium; publicExploit=False; firstDetected=2023-06-08T10:30:35Z}} deviceid : c6a833d9a0da6ad439076368d1781e7940c49fef EXAMPLE 2: Scan computers based on Advanced Hunting Query results The example below achieves the following:\nRuns an Advanced Hunting query to find endpoints where a file has executed in the last 6 hours Triggers a full scan on those endpoints Invoke-PSMDEAdvancedHunting -Query @' DeviceProcessEvents | where Timestamp \u003e ago(6h) | where ActionType == \"ProcessCreated\" | where SHA1 == \"1bc5066ddf693fc034d6514618854e26a85fd0d1\" | distinct DeviceName '@ | Invoke-PSMDEAvscan -ScanType Full Computername : PC123456 type : RunAntiVirusScan ScanType : Full status : Pending errorHResult : 0 requestor : admin@tenant.com requestorComment : Full scan initiated by PSMDE DeviceId : c6a833d9a0da6ad439056368d1681e7940c49fee EXAMPLE 3: Isolate computers The example below performs the following:\nRuns an Advanced Hunting query to find endpoints where PowerShell has communicated with a specific public IP Triggers full isolation of those endpoints Invoke-PSMDEAdvancedHunting -Query @' DeviceNetworkEvents | where Timestamp \u003e ago (6h) | where InitiatingProcessFileName =~\"PowerShell.exe\" | where RemoteIP == \"20.50.201.195\" | distinct DeviceName '@ | Invoke-PSMDEIsolation computername : PC123456 isolationType : Full comment : PSMDE: Isolate device requestor : \u003cadmin@tenant.com\u003e status : Pending deviceid : c6a833d9a0da6ad439056368d1681e7940c49fee EXAMPLE 4 The following example queries a Microsoft URI for the latest available version of Defender for Endpoint:\nGet-PSMDELatestVersion Engine Platform Signatures ------ -------- ---------- 1.1.23070.1005 4.18.23070.1004 1.395.1451.0 This article was originally posted on Write-Verbose.com\n","wordCount":"681","inLanguage":"en","datePublished":"2023-08-27T00:00:00Z","dateModified":"2023-08-27T00:00:00Z","author":{"@type":"Person","name":"GD"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://write-verbose.com/2023/08/27/PSMDE/"},"publisher":{"@type":"Organization","name":"Write-Verbose","logo":{"@type":"ImageObject","url":"https://write-verbose.com/fav/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://write-verbose.com/ accesskey=h title="Write-Verbose (Alt + H)">Write-Verbose</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://write-verbose.com/archives title=Archive><span>Archive</span></a></li><li><a href=https://write-verbose.com/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://write-verbose.com/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://write-verbose.com/about title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://write-verbose.com/>Home</a>&nbsp;»&nbsp;<a href=https://write-verbose.com/posts/>Posts</a></div><h1 class=post-title>PSMDE - PowerShell Defender for Endpoint Module</h1><div class=post-description>A PowerShell Module for access to the Defender Security API.</div><div class=post-meta><span title='2023-08-27 00:00:00 +0000 UTC'>August 27, 2023</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;GD</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#module-functions aria-label="Module Functions">Module Functions</a></li><li><a href=#installation aria-label=Installation>Installation</a><ul><li><a href=#create-azure-app aria-label="Create Azure App">Create Azure App</a></li><li><a href=#install-msalps aria-label="Install MSAL.PS">Install MSAL.PS</a></li><li><a href=#download-psmde aria-label="Download PSMDE">Download PSMDE</a></li></ul></li><li><a href=#usage aria-label=Usage>Usage</a><ul><li><a href=#security-context aria-label="Security Context">Security Context</a></li><li><a href=#interactive-powershell aria-label="Interactive PowerShell">Interactive PowerShell</a></li></ul></li><li><a href=#example-1---get-device-information aria-label="EXAMPLE 1 - Get device information">EXAMPLE 1 - Get device information</a></li><li><a href=#example-2-scan-computers-based-on-advanced-hunting-query-results aria-label="EXAMPLE 2: Scan computers based on Advanced Hunting Query results">EXAMPLE 2: Scan computers based on Advanced Hunting Query results</a></li><li><a href=#example-3-isolate-computers aria-label="EXAMPLE 3: Isolate computers">EXAMPLE 3: Isolate computers</a></li><li><a href=#example-4 aria-label="EXAMPLE 4">EXAMPLE 4</a></li></ul></div></details></div><div class=post-content><p>PSMDE is a PowerShell module providing interactive access to Device information, Advanced Hunting data and machine actions.</p><h2 id=module-functions>Module Functions<a hidden class=anchor aria-hidden=true href=#module-functions>#</a></h2><ul><li>Connect-PSMDE</li><li>Get-PSMDEDeviceInfo</li><li>Get-PSMDELatestVersion</li><li>Invoke-PSMDEAvScan</li><li>Invoke-PSMDEAdvancedHunting</li><li>Invoke-PSMDEIsolation</li><li>Revoke-PSMDEIsolation</li><li>Invoke-PSMDEFileQuarantine</li><li>Save-PSMDESupportInfo</li><li>Test-PSMDEMapsConnection</li></ul><h2 id=installation>Installation<a hidden class=anchor aria-hidden=true href=#installation>#</a></h2><h3 id=create-azure-app>Create Azure App<a hidden class=anchor aria-hidden=true href=#create-azure-app>#</a></h3><p>Create an Azure application to control authentication and authorization.<br>A step by step process is available <a href=https://write-verbose.com/2023/05/24/DefenderSecurityAPI/ target=_blank>here</a>
The API permissions required are available in the Help text of each module function.</p><h3 id=install-msalps>Install MSAL.PS<a hidden class=anchor aria-hidden=true href=#install-msalps>#</a></h3><p>PSMDE relies on another module for authentication. Install the <strong>MSAL.PS</strong> module from the PowerShell gallery.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-PowerShell data-lang=PowerShell><span class=line><span class=cl><span class=nb>Install-Module</span> <span class=n>MSAL</span><span class=p>.</span><span class=nb>PS </span><span class=n>-Scope</span> <span class=n>CurrentUser</span>
</span></span></code></pre></div><h3 id=download-psmde>Download PSMDE<a hidden class=anchor aria-hidden=true href=#download-psmde>#</a></h3><p>The PSMDE module is <a href=https://github.com/gbdixg/PSMDE target=_blank>available from GitHub</a><br>Click on Code > Download Zip<br>Unblock the zip file and extract it to a folder in the $ENV:PSModule path<br>Make sure you rename the root folder from <em>PSMDE-master</em> to <strong>PSMDE</strong><br>Edit the Public\<strong>Connect-PSMDE.ps1</strong> file to set your TenantID and ApplicationID</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-PowerShell data-lang=PowerShell><span class=line><span class=cl><span class=c># Connect-PSMDE before edit</span>
</span></span><span class=line><span class=cl><span class=k>Param</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=nb>parameter</span><span class=p>()]</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=nb>ValidateNotNullOrEmpty</span><span class=p>()]</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=no>String</span><span class=p>]</span><span class=nv>$TenantID</span> <span class=p>=</span> <span class=s1>&#39;00000000-0000-0000-0000-TENANTID&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=nb>parameter</span><span class=p>()]</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=nb>ValidateNotNullOrEmpty</span><span class=p>()]</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=no>String</span><span class=p>]</span><span class=nv>$ClientID</span> <span class=p>=</span> <span class=s1>&#39;00000000-0000-0000-0000-APPID&#39;</span>
</span></span></code></pre></div><h2 id=usage>Usage<a hidden class=anchor aria-hidden=true href=#usage>#</a></h2><h3 id=security-context>Security Context<a hidden class=anchor aria-hidden=true href=#security-context>#</a></h3><p>Start PowerShell in the context of an account with access to Defender information i.e. a member of</p><ul><li>A built in reader role such as <em>Global Reader</em> or <em>Security Reader</em></li><li>A privileged role such as <em>Global Admin, Security Opertator, Security Admin</em></li><li>A custom role with delegated access to your tenant</li></ul><h3 id=interactive-powershell>Interactive PowerShell<a hidden class=anchor aria-hidden=true href=#interactive-powershell>#</a></h3><p>Use the module interactively at PowerShell console and explore the module functions</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-PowerShell data-lang=PowerShell><span class=line><span class=cl><span class=nb>Import-Module</span> <span class=n>PSMDE</span> <span class=c># Load the module </span>
</span></span><span class=line><span class=cl><span class=nb>Get-Command</span> <span class=n>-Module</span> <span class=n>PSMDE</span> <span class=c># List available commands</span>
</span></span><span class=line><span class=cl><span class=nb>Get-Help</span> <span class=nb>Get-PSMDEDeviceInfo</span> <span class=c># Get help on a command</span>
</span></span></code></pre></div><h2 id=example-1---get-device-information>EXAMPLE 1 - Get device information<a hidden class=anchor aria-hidden=true href=#example-1---get-device-information>#</a></h2><p>The example below confirms the following for an endpoint:</p><ul><li>Defender is active and onboarded</li><li>Engine and signatures are up-to-date</li><li>Last scan times</li><li>OS version and IP address information</li><li>Logged-on users</li><li>MDE alerts</li><li>Vulnerabilities</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-PowerShell data-lang=PowerShell><span class=line><span class=cl><span class=nb>Import-Module</span> <span class=n>PSMDE</span>  
</span></span><span class=line><span class=cl><span class=nb>Connect-PSMDE</span> <span class=n>-TenantID</span> <span class=nv>$TenantID</span> <span class=n>-ClientID</span> <span class=nv>$AppID</span> <span class=c># Optional parameters. Set defaults in the Connect-PSMDE.ps1 file</span>
</span></span><span class=line><span class=cl><span class=nb>Get-PSMDEDeviceInfo</span> <span class=n>-Computername</span> <span class=n>PC12345</span>  
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-cmd data-lang=cmd><span class=line><span class=cl>Computername                  : PC12345
</span></span><span class=line><span class=cl>osPlatform                    : Windows10
</span></span><span class=line><span class=cl>version                       : 22H2
</span></span><span class=line><span class=cl>osBuild                       : 19045
</span></span><span class=line><span class=cl>isPotentialDuplication        : False
</span></span><span class=line><span class=cl>machineTags                   : {MDEPilot}
</span></span><span class=line><span class=cl>healthStatus                  : Active
</span></span><span class=line><span class=cl>onboardingStatus              : Onboarded
</span></span><span class=line><span class=cl>defenderAvStatus              : Updated
</span></span><span class=line><span class=cl>exposureLevel                 : Medium
</span></span><span class=line><span class=cl>riskScore                     : Medium
</span></span><span class=line><span class=cl>avEngineVersion               : 1.1.23080.2005
</span></span><span class=line><span class=cl>avSignatureVersion            : 1.395.1403.0
</span></span><span class=line><span class=cl>avPlatformVersion             : 4.18.23080.2006
</span></span><span class=line><span class=cl>avIsSignatureUpToDate         : True
</span></span><span class=line><span class=cl>avIsEngineUpToDate            : True
</span></span><span class=line><span class=cl>avIsPlatformUpToDate          : True
</span></span><span class=line><span class=cl>avSignatureDataRefreshTime    : 27/08/2023 15:35:36
</span></span><span class=line><span class=cl>avSignatureDataRefreshTimeUTC : 27/08/2023 14:35:36
</span></span><span class=line><span class=cl>quickScanTime                 : 22/08/2023 03:16:00
</span></span><span class=line><span class=cl>quickScanTimeUTC              : 22/08/2023 02:16:00
</span></span><span class=line><span class=cl>fullScanTime                  : 
</span></span><span class=line><span class=cl>fullScanTimeUTC               : 
</span></span><span class=line><span class=cl>avmode                        : 0
</span></span><span class=line><span class=cl>LastSeen                      : 27/08/2023 14:53:08
</span></span><span class=line><span class=cl>LastSeenUTC                   : 27/08/2023 13:53:08
</span></span><span class=line><span class=cl>lastIpAddress                 : 192.168.1.140
</span></span><span class=line><span class=cl>lastExternalIpAddress         : 100.19.112.28
</span></span><span class=line><span class=cl>managedBy                     : Intune
</span></span><span class=line><span class=cl>loggedOnUsers                 : {@{id=RnD\user1; lastSeen=27/08/2023 16:23:38; logonTypes=RemoteInteractive}, @{id=azuread\admin1; lastSeen=27/08/2023 16:02:54; logonTypes=Interactive}}
</span></span><span class=line><span class=cl>alertCount                    : 9
</span></span><span class=line><span class=cl>alerts                        : {@{serverity=Informational; alertCreationTime=2023-05-08T19:45:47.8359999Z; detectionSource=AutomatedInvestigation; category=SuspiciousActivity; threatName=; threatFamilyName=}, 
</span></span><span class=line><span class=cl>                                <span class=p>@</span>{serverity=Informational; alertCreationTime=2023-08-15T21:55:56.9250938Z; detectionSource=WindowsDefenderAv; category=Malware; threatName=Virus:DOS/EICAR_Test_File; 
</span></span><span class=line><span class=cl>                                threatFamilyName=EICAR_Test_File}, @{serverity=Medium; alertCreationTime=2023-05-08T16:11:02.4388031Z; detectionSource=WindowsDefenderAv; category=SuspiciousActivity; 
</span></span><span class=line><span class=cl>                                threatName=Trojan:PowerShell/Powersploit.L; threatFamilyName=Powersploit}, @{serverity=Medium; alertCreationTime=2023-05-08T16:02:13.0120825Z; detectionSource=WindowsDefenderAtp; 
</span></span><span class=line><span class=cl>                                category=Execution; threatName=; threatFamilyName=}...}
</span></span><span class=line><span class=cl>CVEs                          : {@{name=CVE-2023-33144; description=Visual Studio Code Spoofing Vulnerability; severity=Medium; publicExploit=False; firstDetected=2023-06-13T17:30:51Z}, @{name=CVE-2023-21779; 
</span></span><span class=line><span class=cl>                                description=Visual Studio Code Remote Code Execution Vulnerability; severity=High; publicExploit=False; firstDetected=2023-05-02T14:45:15Z}, @{name=CVE-2023-24893; description=Visual 
</span></span><span class=line><span class=cl>                                Studio Code Remote Code Execution Vulnerability; severity=High; publicExploit=False; firstDetected=2023-05-02T14:45:15Z}, @{name=CVE-2023-29338; description=Visual Studio Code 
</span></span><span class=line><span class=cl>                                Information Disclosure Vulnerability; severity=Medium; publicExploit=False; firstDetected=2023-06-08T10:30:35Z}}
</span></span><span class=line><span class=cl>deviceid                      : c6a833d9a0da6ad439076368d1781e7940c49fef
</span></span></code></pre></div><h2 id=example-2-scan-computers-based-on-advanced-hunting-query-results>EXAMPLE 2: Scan computers based on Advanced Hunting Query results<a hidden class=anchor aria-hidden=true href=#example-2-scan-computers-based-on-advanced-hunting-query-results>#</a></h2><p>The example below achieves the following:</p><ul><li>Runs an Advanced Hunting query to find endpoints where a file has executed in the last 6 hours</li><li>Triggers a full scan on those endpoints</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-PowerShell data-lang=PowerShell><span class=line><span class=cl><span class=nb>Invoke-PSMDEAdvancedHunting</span> <span class=n>-Query</span> <span class=p>@</span><span class=s1>&#39;  
</span></span></span><span class=line><span class=cl><span class=s1>DeviceProcessEvents
</span></span></span><span class=line><span class=cl><span class=s1>| where Timestamp &gt; ago(6h)
</span></span></span><span class=line><span class=cl><span class=s1>| where ActionType == &#34;ProcessCreated&#34;
</span></span></span><span class=line><span class=cl><span class=s1>| where SHA1 == &#34;1bc5066ddf693fc034d6514618854e26a85fd0d1&#34;
</span></span></span><span class=line><span class=cl><span class=s1>| distinct DeviceName 
</span></span></span><span class=line><span class=cl><span class=s1>&#39;</span><span class=p>@</span> <span class=p>|</span> <span class=nb>Invoke-PSMDEAvscan</span> <span class=n>-ScanType</span> <span class=n>Full</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-cmd data-lang=cmd><span class=line><span class=cl>Computername     : PC123456
</span></span><span class=line><span class=cl><span class=k>type</span>             : RunAntiVirusScan
</span></span><span class=line><span class=cl>ScanType         : Full
</span></span><span class=line><span class=cl>status           : Pending
</span></span><span class=line><span class=cl>errorHResult     : 0
</span></span><span class=line><span class=cl>requestor        : admin@tenant.com
</span></span><span class=line><span class=cl>requestorComment : Full scan initiated by PSMDE
</span></span><span class=line><span class=cl>DeviceId         : c6a833d9a0da6ad439056368d1681e7940c49fee
</span></span></code></pre></div><h2 id=example-3-isolate-computers>EXAMPLE 3: Isolate computers<a hidden class=anchor aria-hidden=true href=#example-3-isolate-computers>#</a></h2><p>The example below performs the following:</p><ul><li>Runs an Advanced Hunting query to find endpoints where PowerShell has communicated with a specific public IP</li><li>Triggers full isolation of those endpoints</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-PowerShell data-lang=PowerShell><span class=line><span class=cl><span class=nb>Invoke-PSMDEAdvancedHunting</span> <span class=n>-Query</span> <span class=p>@</span><span class=s1>&#39;  
</span></span></span><span class=line><span class=cl><span class=s1>DeviceNetworkEvents
</span></span></span><span class=line><span class=cl><span class=s1>| where Timestamp &gt; ago (6h)
</span></span></span><span class=line><span class=cl><span class=s1>| where InitiatingProcessFileName =~&#34;PowerShell.exe&#34;
</span></span></span><span class=line><span class=cl><span class=s1>| where RemoteIP == &#34;20.50.201.195&#34;
</span></span></span><span class=line><span class=cl><span class=s1>| distinct DeviceName
</span></span></span><span class=line><span class=cl><span class=s1>&#39;</span><span class=p>@</span> <span class=p>|</span> <span class=nb>Invoke-PSMDEIsolation</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-cmd data-lang=cmd><span class=line><span class=cl>computername  : PC123456
</span></span><span class=line><span class=cl>isolationType : Full
</span></span><span class=line><span class=cl>comment       : PSMDE: Isolate device
</span></span><span class=line><span class=cl>requestor     : <span class=p>&lt;</span>admin@tenant.com&gt;
</span></span><span class=line><span class=cl>status        : Pending
</span></span><span class=line><span class=cl>deviceid      : c6a833d9a0da6ad439056368d1681e7940c49fee
</span></span></code></pre></div><h2 id=example-4>EXAMPLE 4<a hidden class=anchor aria-hidden=true href=#example-4>#</a></h2><p>The following example queries a Microsoft URI for the latest available version of Defender for Endpoint:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-PowerShell data-lang=PowerShell><span class=line><span class=cl><span class=nb>Get-PSMDELatestVersion</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-cmd data-lang=cmd><span class=line><span class=cl>Engine         Platform        Signatures
</span></span><span class=line><span class=cl>------         --------        ----------
</span></span><span class=line><span class=cl>1.1.23070.1005 4.18.23070.1004 1.395.1451.0
</span></span></code></pre></div><p><br><br></p><blockquote><p>This article was originally posted on <a href=http://write-verbose.com target=_blank>Write-Verbose.com</a></p></blockquote></div><footer class=post-footer><ul class=post-tags><li><a href=https://write-verbose.com/tags/powershell/>PowerShell</a></li><li><a href=https://write-verbose.com/tags/defender/>Defender</a></li></ul><nav class=paginav><a class=prev href=https://write-verbose.com/2023/10/12/FirewallVPN/><span class=title>« Prev</span><br><span>Third-party Windows VPN? Always add these registry values</span></a>
<a class=next href=https://write-verbose.com/2023/08/20/GitClean/><span class=title>Next »</span><br><span>Replace sensitive information before committing PowerShell scripts using Git Clean and Smudge Filters</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share PSMDE - PowerShell Defender for Endpoint Module on twitter" href="https://twitter.com/intent/tweet/?text=PSMDE%20-%20PowerShell%20Defender%20for%20Endpoint%20Module&url=https%3a%2f%2fwrite-verbose.com%2f2023%2f08%2f27%2fPSMDE%2f&hashtags=PowerShell%2cDefender"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share PSMDE - PowerShell Defender for Endpoint Module on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fwrite-verbose.com%2f2023%2f08%2f27%2fPSMDE%2f&title=PSMDE%20-%20PowerShell%20Defender%20for%20Endpoint%20Module&summary=PSMDE%20-%20PowerShell%20Defender%20for%20Endpoint%20Module&source=https%3a%2f%2fwrite-verbose.com%2f2023%2f08%2f27%2fPSMDE%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share PSMDE - PowerShell Defender for Endpoint Module on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwrite-verbose.com%2f2023%2f08%2f27%2fPSMDE%2f&title=PSMDE%20-%20PowerShell%20Defender%20for%20Endpoint%20Module"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share PSMDE - PowerShell Defender for Endpoint Module on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwrite-verbose.com%2f2023%2f08%2f27%2fPSMDE%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share PSMDE - PowerShell Defender for Endpoint Module on whatsapp" href="https://api.whatsapp.com/send?text=PSMDE%20-%20PowerShell%20Defender%20for%20Endpoint%20Module%20-%20https%3a%2f%2fwrite-verbose.com%2f2023%2f08%2f27%2fPSMDE%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share PSMDE - PowerShell Defender for Endpoint Module on telegram" href="https://telegram.me/share/url?text=PSMDE%20-%20PowerShell%20Defender%20for%20Endpoint%20Module&url=https%3a%2f%2fwrite-verbose.com%2f2023%2f08%2f27%2fPSMDE%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://write-verbose.com/>Write-Verbose</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>