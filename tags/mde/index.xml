<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>MDE on Write-Verbose</title>
    <link>https://write-verbose.com/tags/mde/</link>
    <description>Recent content in MDE on Write-Verbose</description>
    <image>
      <title>Write-Verbose</title>
      <url>https://write-verbose.com/papermod-cover.png</url>
      <link>https://write-verbose.com/papermod-cover.png</link>
    </image>
    <generator>Hugo -- gohugo.io</generator>
    <lastBuildDate>Sun, 13 Aug 2023 00:00:00 +0000</lastBuildDate><atom:link href="https://write-verbose.com/tags/mde/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>Create a Hyper-V VM with a differencing disk using PowerShell</title>
      <link>https://write-verbose.com/2023/08/13/HyperVDiff/</link>
      <pubDate>Sun, 13 Aug 2023 00:00:00 +0000</pubDate>
      
      <guid>https://write-verbose.com/2023/08/13/HyperVDiff/</guid>
      <description>Save GBs of disk space when there are multiple VMs with the same OS and base configuration</description>
      <content:encoded><![CDATA[<p>This post cover the following:</p>
<ul>
<li>An overview of the steps to create the parent virtual disk</li>
<li>A script to automate creation of child VMs with a differencing disk</li>
</ul>
<h2 id="environment">Environment</h2>
<p>My environment is a Windows 11 host running Client Hyper-V. The VMs are running Windows 11 Enterprise (Eval).<br>
I&rsquo;m using PowerShell 5.1 and haven&rsquo;t tested on other versions of the OS or PowerShell.</p>
<h2 id="parent-disk-creation">Parent Disk creation</h2>
<p>The following is a brief overview of creating the base image that becomes the parent disk.</p>
<ul>
<li>Create a Hyper-V Generation 2 VM</li>
<li>Enable the TPM (Settings &gt; Security)</li>
<li>Install Windows 11</li>
<li>During the OOBE phase, select <em>Other Signin Options &gt; Domain Join</em></li>
<li>Create a local user e.g. &ldquo;Bob&rdquo;</li>
<li>Log on as Bob and configure the system and software</li>
<li>NOTE: Install all software per machine or Sysprep will fail</li>
<li>Enable the built-in Administrator account and set the password</li>
<li>Log off from the Bob account and log on as Administrator</li>
<li>Delete the local profile for Bob&rsquo;s account as follows:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-PowerShell" data-lang="PowerShell"><span class="line"><span class="cl"><span class="nv">$p</span> <span class="p">=</span> <span class="nb">Get-WMIObject</span> <span class="n">-Class</span> <span class="n">Win32_UserProfile</span> <span class="n">-Filter</span> <span class="s2">&#34;LocalPath=&#39;c:\\users\\Bob&#39;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$p</span><span class="p">.</span><span class="py">Delete</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="nv">$p</span><span class="p">.</span><span class="py">Dispose</span><span class="p">()</span>
</span></span></code></pre></div><ul>
<li>Delete the local user account for Bob</li>
<li>Run Sysprep as follows:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">c<span class="p">:</span><span class="nl">\windows\system32\sysprep\sysprep.exe</span><span class="c1"> /generalize /oobe /mode:vm</span>
</span></span></code></pre></div><ul>
<li>Delete the VM in the Hyper-V console (the disk will remain)</li>
<li>Move the VHDX disk file to an appropriate location and set the NTFS properties to be read-only.</li>
</ul>
<h2 id="powershell-script">PowerShell Script</h2>
<p>The script below creates a new VM with a <em>Differencing Disk</em> linked to the parent disk.<br>
The main benefits of a Differencing Disk are:</p>
<ul>
<li>Rapid deployment - only have to go through OOBE and you have a working OS</li>
<li>Save disk space - the base OS is in the parent disk</li>
</ul>
<h3 id="example">Example</h3>
<p><img loading="lazy" src="/img/DiffVM/NewDiffVM.png" alt="New-DiffVM"  />
</p>
<h3 id="script">Script</h3>
<script type="application/javascript" src="https://gist.github.com/gbdixg/ff17941b17b31cacf0b62d9e6c1c4f42.js"></script>

<p><br/><br/></p>
<blockquote>
<p>This article was originally posted on <a href="http://write-verbose.com" target="_blank">Write-Verbose.com</a></p>
</blockquote>]]></content:encoded>
    </item>
    
    <item>
      <title>Bypassing Defender EDR using Windows Firewall - mitigations</title>
      <link>https://write-verbose.com/2022/05/31/EDRBypass/</link>
      <pubDate>Wed, 31 May 2023 00:00:00 +0000</pubDate>
      
      <guid>https://write-verbose.com/2022/05/31/EDRBypass/</guid>
      <description>How to prevent an attacker using Windows Firewall to bypass Endpoint Detection</description>
      <content:encoded><![CDATA[<p>Attackers can use Windows Firewall to block EDR telemetry leaving the endpoint.  Read-on for how this is mitigated.</p>
<h2 id="risk-background">Risk background</h2>
<p>As well as the usual source and destination variables, Windows Firewall can also block outbound communication based on the <em>service name</em> or <em>program</em> that initiates the communication.</p>
<p>An attacker with elevated endpoint access will want to shut down Defender EDR as soon as possible and one method is to block the client agent communication with the cloud service.</p>
<p>The following PowerShell commands can achieve this, blocking outbound TCP/443 from:</p>
<ul>
<li><em>WinDefend</em> service (main MDAV process)</li>
<li><em>SenseCNDProxy</em> process (acts as a communication broker)</li>
<li><em>MSSense</em> process (Main MDE process)</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-PowerShell" data-lang="PowerShell"><span class="line"><span class="cl"><span class="c"># PowerShell commands to Disable outbound 443 from MDE agent to cloud service</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">New-NetFirewallRule</span> <span class="n">-DisplayName</span> <span class="s2">&#34;Block 443 MsMpEng&#34;</span> <span class="n">-Name</span> <span class="s2">&#34;Block 443 MsMpEng&#34;</span> <span class="n">-Direction</span> <span class="n">Outbound</span> <span class="n">-Service</span> <span class="n">WinDefend</span> <span class="n">-Enabled</span> <span class="n">True</span> <span class="n">-RemotePort</span> <span class="mf">443</span> <span class="n">-Protocol</span> <span class="n">TCP</span> <span class="n">-Action</span> <span class="n">Block</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">New-NetFirewallRule</span> <span class="n">-DisplayName</span> <span class="s2">&#34;Block 443 SenseCncProxy&#34;</span> <span class="n">-Name</span> <span class="s2">&#34;Block 443 SenseCncProxy&#34;</span> <span class="n">-Direction</span> <span class="n">Outbound</span> <span class="n">-Program</span> <span class="s2">&#34;%ProgramFiles%\Windows Defender Advanced Threat Protection\SenseCncProxy.exe&#34;</span> <span class="n">-RemotePort</span> <span class="mf">443</span> <span class="n">-Protocol</span> <span class="n">TCP</span> <span class="n">-Action</span> <span class="n">Block</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">New-NetFirewallRule</span> <span class="n">-DisplayName</span> <span class="s2">&#34;Block 443 MsSense&#34;</span> <span class="n">-Name</span> <span class="s2">&#34;Block 443 MsSense&#34;</span> <span class="n">-Direction</span> <span class="n">Outbound</span> <span class="n">-Program</span> <span class="s2">&#34;%ProgramFiles%\Windows Defender Advanced Threat Protection\MsSense.exe&#34;</span> <span class="n">-RemotePort</span> <span class="mf">443</span> <span class="n">-Protocol</span> <span class="n">TCP</span> <span class="n">-Action</span> <span class="n">Block</span>
</span></span></code></pre></div><h2 id="mitigation">Mitigation</h2>
<h3 id="1---tamper-protection">1 - Tamper Protection</h3>
<p>The most important mitigation is to enable <strong>MDE Tamper Protection</strong>.</p>
<p>Tamper protection prevents users with elevated rights on the endpoint making changes to the MDE client configuration. Tamper Projection includes prevention of local firewall rules affecting MDE processes.  If you run the commands above, MDE will generate an alert and block the changes.</p>
<p>Enable Tamper Protection as follows:</p>
<blockquote>
<p>MDE Security Portal &gt; Settings &gt; Endpoints &gt; Advanced Features &gt; Tamper Protection = On</p>
</blockquote>
<h3 id="2--firewall-rule-merging">2- Firewall Rule Merging</h3>
<p>Windows Firewall local rule merging should be disabled to prevent local changes.</p>
<p>The Windows Firewall has <em>Rule Sources</em>.  For example, Group Policy is one rule source and local rules are another. When the Firewall is managed by GPO or Intune, it still allows local rule merging by default.</p>
<p>When rule merging is enabled, local block rules can over-ride policy-based allow rules. Similarly, local allow rules can override policy-based profile defaults (profile defaults are initial rules applied to each profile - Domain / Private / Public).</p>
<p>Disable Local Rule Merging as follows:</p>
<p>Group Policy Editor:</p>
<blockquote>
<p>Computer Configuration &gt; Security Settings &gt; Windows Firewall with Advanced Security &gt; Properties &gt; Settings &gt; [PROFILE NAME] &gt; Settings &gt; Apply local firewall rules = No</p>
</blockquote>
<p>Intune Policy:</p>
<blockquote>
<p>Endpoint security &gt; Firewall &gt; Create policy &gt; Create a profile &gt; Windows 10 / 11 / Server &gt; Microsoft Defender Firewall &gt; [Provide a Name] &gt; Allow local policy merge = False</p>
</blockquote>
<h2 id="summary">Summary</h2>
<p>With Tamper Protection enabled and Windows Firewall local rule merging disabled, the chances of at attacker abusing firewall rules are slim.</p>
<p><br/><br/></p>
<blockquote>
<p>This article was originally posted on <a href="http://write-verbose.com" target="_blank">Write-Verbose.com</a></p>
</blockquote>]]></content:encoded>
    </item>
    
    <item>
      <title>Enable Defender Firewall event forwarding to MDE</title>
      <link>https://write-verbose.com/2023/02/02/Firewallmde/</link>
      <pubDate>Thu, 02 Feb 2023 00:00:00 +0000</pubDate>
      
      <guid>https://write-verbose.com/2023/02/02/Firewallmde/</guid>
      <description>A reminder that Firewall Events are not available in MDE Advanced Hunting by default</description>
      <content:encoded><![CDATA[<p>You may notice that Windows Firewall events are not available in Defender for Endpoint Advanced Hunting. This is a quick post on the steps required to enable Firewall audit events.</p>
<p><a href="https://medium.com/@olafhartong" target="_blank">Olaf Hartong&amp;rsquo;s excellent series on MDE Internals</a> highlights that some MDE telemetry is based on Kernel call-backs or drivers, making those areas independent of client audit policy and enabled by default.</p>
<p>Other settings, however, do rely on ETW providers and therefore on the MDE client&rsquo;s security audit policy. Firewall audit events will only be available in MDE if the relevant audit subcategory is enabled.</p>
<h2 id="enable-client-side-firewall-auditing">Enable client-side Firewall auditing</h2>
<p>The following <em>auditpol</em> command will enable Windows Firewall client-side auditing and start sending the telemetry to MDE.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">auditpol /set /subcategory:<span class="s2">&#34;Filtering Platform Connection&#34;</span> /success:disable /failure:enable
</span></span></code></pre></div><p>It&rsquo;s fine to keep this enabled during day-to-day use as it will result in the following</p>
<ul>
<li>Blocked connections create an audit event in the Security Event Log</li>
<li>Allowed connections do not create an audit event</li>
<li><strong>A single audit event is created for each connection attempt</strong>, not each packet</li>
</ul>
<p>I don&rsquo;t recommend auditing Filtering Platform Connection <em>success</em> events as this will generate a lot of events. You may be tempted to also enable <em>Filtering Platform Packet Drop</em>, but this would also generate a high volume.</p>
<h2 id="intune">Intune</h2>
<p>You could of-course use Intune to apply the same setting to an enrolled Windows client. Create a <em>Device Configuration Profile</em> based on the <strong>Settings Catalog</strong>. Enter <em>Filtering</em> in the settings search and enable <em>Success</em> auditing for <strong>Object Access Audit Filtering Platform Connection</strong></p>
<h2 id="advanced-hunting-query">Advanced Hunting Query</h2>
<p>You can view the Firewall events in MDE Avanced Hunting as follows:</p>
<pre tabindex="0"><code class="language-KQL" data-lang="KQL">DeviceEvents
| where Timestamp &gt; ago(1d)
| where ActionType startswith &#34;Firewall&#34;
</code></pre><p>EXAMPLE RESULT:</p>
<table>
<thead>
<tr>
<th>Timestamp</th>
<th>ComputerName</th>
<th>ActionType</th>
<th>IPAddress</th>
<th>RemoteIPCountry</th>
<th>RemoteIPAddr</th>
<th>RemotePort</th>
<th>Protocol</th>
<th>Direction</th>
<th>NetworkProfile</th>
<th>InterfaceType</th>
<th>RuleId</th>
<th>RuleName</th>
<th>Action</th>
<th>Application</th>
<th>Service</th>
<th>User</th>
<th>InitiatingProcess</th>
<th>InitiatingProcessPath</th>
<th>InitiatingProcessCommandLine</th>
</tr>
</thead>
<tbody>
<tr>
<td>2023-02-02T10:30:12.000Z</td>
<td>DESKTOP01</td>
<td>Firewall</td>
<td>192.168.1.100</td>
<td>United States</td>
<td>54.239.29.192</td>
<td>443</td>
<td>TCP</td>
<td>Outbound</td>
<td>Domain</td>
<td>Wi-Fi</td>
<td></td>
<td></td>
<td>Allowed</td>
<td>Chrome.exe</td>
<td></td>
<td>User1</td>
<td>chrome.exe</td>
<td>C:\Program Files (x86)\Google\Chrome\chrome.exe</td>
<td></td>
</tr>
<tr>
<td>2023-02-02T09:01:30.000Z</td>
<td>DESKTOP02</td>
<td>Firewall</td>
<td>192.168.1.200</td>
<td>United States</td>
<td>91.189.91.26</td>
<td>53</td>
<td>UDP</td>
<td>Outbound</td>
<td>Public</td>
<td>Ethernet</td>
<td></td>
<td></td>
<td>Blocked</td>
<td>svchost.exe</td>
<td>DNS</td>
<td>User2</td>
<td>svchost.exe</td>
<td>C:\Windows\System32\svchost.exe</td>
<td></td>
</tr>
<tr>
<td>2023-02-02T08:45:55.000Z</td>
<td>DESKTOP03</td>
<td>Firewall</td>
<td>192.168.1.150</td>
<td>Canada</td>
<td>185.104.10.98</td>
<td>80</td>
<td>TCP</td>
<td>Inbound</td>
<td>Private</td>
<td>Wi-Fi</td>
<td></td>
<td></td>
<td>Blocked</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="example-event-in-windows-security-log">Example Event in Windows Security Log</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Log Name: Security
</span></span><span class="line"><span class="cl">Source: Microsoft Windows Security Auditing
</span></span><span class="line"><span class="cl">Date: 5/2/2023 10:31:12 AM
</span></span><span class="line"><span class="cl">Event ID: <span class="m">5444</span>
</span></span><span class="line"><span class="cl">Task Category: Filtering Platform Connection
</span></span><span class="line"><span class="cl">Level: Information
</span></span><span class="line"><span class="cl">Keywords: Audit Failure
</span></span><span class="line"><span class="cl">User: N/A
</span></span><span class="line"><span class="cl">Computer: MyComputer
</span></span><span class="line"><span class="cl">Description:
</span></span><span class="line"><span class="cl">A network connection request was blocked.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Subject:
</span></span><span class="line"><span class="cl">Security ID: S-1-5-18
</span></span><span class="line"><span class="cl">Account Name: MyComputer$
</span></span><span class="line"><span class="cl">Account Domain: MYDOMAIN
</span></span><span class="line"><span class="cl">Logon ID: 0x3E7
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Network Information:
</span></span><span class="line"><span class="cl">Direction: Inbound
</span></span><span class="line"><span class="cl">Source Address: 192.168.1.100
</span></span><span class="line"><span class="cl">Source Port: <span class="m">54321</span>
</span></span><span class="line"><span class="cl">Destination Address: 192.168.1.200
</span></span><span class="line"><span class="cl">Destination Port: <span class="m">80</span>
</span></span><span class="line"><span class="cl">Protocol: TCP
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Filter Information:
</span></span><span class="line"><span class="cl">Filter Run-Time ID: <span class="m">157314</span>
</span></span><span class="line"><span class="cl">Layer Name: Transport
</span></span><span class="line"><span class="cl">Layer Run-Time ID: <span class="m">13</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Additional Information:
</span></span><span class="line"><span class="cl">Reason: The rule does not match the traffic.
</span></span></code></pre></div><p><br/><br/></p>
<blockquote>
<p>This article was originally posted on <a href="http://write-verbose.com" target="_blank">Write-Verbose.com</a></p>
</blockquote>]]></content:encoded>
    </item>
    
  </channel>
</rss>
